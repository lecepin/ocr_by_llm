<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å›¾ç‰‡æ–‡å­—è¯†åˆ«</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont,
          "Segoe UI", Roboto, sans-serif;
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        padding: 40px;
        backdrop-filter: blur(10px);
      }

      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
        font-size: 1.8em;
        font-weight: 300;
      }

      .upload-area {
        border: 3px dashed #667eea;
        border-radius: 12px;
        padding: 15px;
        text-align: center;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        cursor: pointer;
        background: rgba(102, 126, 234, 0.05);
      }

      .upload-area:hover {
        border-color: #764ba2;
        background: rgba(118, 75, 162, 0.1);
        transform: translateY(-2px);
      }

      .upload-area.dragover {
        border-color: #764ba2;
        background: rgba(118, 75, 162, 0.15);
        transform: scale(1.02);
      }

      .upload-icon {
        font-size: 1.8em;
        color: #667eea;
        margin-bottom: 6px;
      }

      .upload-text {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 6px;
      }

      .upload-hint {
        font-size: 0.75em;
        color: #999;
      }

      .file-input {
        display: none;
      }

      .preview-area {
        margin-bottom: 20px;
        text-align: center;
      }

      .preview-image {
        max-width: 80%;
        max-height: 200px;
        border-radius: 8px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 15px;
      }

      .controls {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      .checkbox-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }

      .checkbox {
        width: 20px;
        height: 20px;
        border: 2px solid #667eea;
        border-radius: 4px;
        position: relative;
        cursor: pointer;
      }

      .checkbox input {
        opacity: 0;
        position: absolute;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }

      .checkbox input:checked + .checkmark {
        background: #667eea;
      }

      .checkbox input:checked + .checkmark::after {
        content: "âœ“";
        position: absolute;
        color: white;
        font-size: 14px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      .checkmark {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 2px;
        transition: all 0.2s ease;
      }

      .btn {
        padding: 10px 24px;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .btn-primary {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      }

      .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .btn-copy {
        background: linear-gradient(45deg, #11998e, #38ef7d);
        color: white;
        box-shadow: 0 5px 15px rgba(17, 153, 142, 0.3);
      }

      .btn-copy:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(17, 153, 142, 0.4);
      }

      .result-area {
        margin-top: 30px;
      }

      .result-textarea {
        width: 100%;
        min-height: 180px;
        padding: 16px;
        border: 2px solid #e0e0e0;
        border-radius: 15px;
        font-size: 0.9em;
        line-height: 1.5;
        resize: vertical;
        background: rgba(255, 255, 255, 0.8);
        transition: all 0.3s ease;
      }

      .result-textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 20px rgba(102, 126, 234, 0.2);
      }

      .loading {
        display: none;
        text-align: center;
        margin: 20px 0;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #e0e0e0;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error-message {
        background: #ffebee;
        color: #c62828;
        padding: 15px;
        border-radius: 10px;
        margin: 15px 0;
        border-left: 4px solid #c62828;
        display: none;
      }

      .success-message {
        background: #e8f5e8;
        color: #2e7d32;
        padding: 15px;
        border-radius: 10px;
        margin: 15px 0;
        border-left: 4px solid #2e7d32;
        display: none;
      }

      @media (max-width: 600px) {
        .container {
          padding: 20px;
          margin: 10px;
        }

        h1 {
          font-size: 1.5em;
        }

        .upload-area {
          padding: 12px 10px;
        }

        .preview-image {
          max-width: 90%;
          max-height: 150px;
        }

        .controls {
          flex-direction: column;
          align-items: stretch;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ“· å›¾ç‰‡æ–‡å­—è¯†åˆ«</h1>

      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">ğŸ“</div>
        <div class="upload-text">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</div>
        <div class="upload-hint">
          æ”¯æŒ PNGã€JPGã€GIF æ ¼å¼ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç²˜è´´å‰ªè´´æ¿ä¸­çš„å›¾ç‰‡
        </div>
        <input type="file" id="fileInput" class="file-input" accept="image/*" />
      </div>

      <div class="preview-area" id="previewArea" style="display: none">
        <img id="previewImage" class="preview-image" alt="é¢„è§ˆå›¾ç‰‡" />
      </div>

      <div class="controls">
        <label class="checkbox-wrapper">
          <div class="checkbox">
            <input type="checkbox" id="oneLineMode" />
            <div class="checkmark"></div>
          </div>
          <span>åˆå¹¶ä¸ºä¸€è¡Œï¼ˆå»é™¤æ¢è¡Œï¼‰</span>
        </label>

        <button class="btn btn-primary" id="recognizeBtn" disabled>
          <span>ğŸ”</span>
          <span>å¼€å§‹è¯†åˆ«</span>
        </button>
      </div>

      <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div>æ­£åœ¨è¯†åˆ«ä¸­ï¼Œè¯·ç¨å€™...</div>
      </div>

      <div class="error-message" id="errorMessage"></div>
      <div class="success-message" id="successMessage"></div>

      <div class="result-area">
        <textarea
          id="resultTextarea"
          class="result-textarea"
          placeholder="è¯†åˆ«ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."
        ></textarea>
        <br /><br />
        <button class="btn btn-copy" id="copyBtn" style="display: none">
          <span>ğŸ“‹</span>
          <span>å¤åˆ¶ç»“æœ</span>
        </button>
      </div>
    </div>

    <script>
      const uploadArea = document.getElementById("uploadArea");
      const fileInput = document.getElementById("fileInput");
      const previewArea = document.getElementById("previewArea");
      const previewImage = document.getElementById("previewImage");
      const recognizeBtn = document.getElementById("recognizeBtn");
      const oneLineMode = document.getElementById("oneLineMode");
      const resultTextarea = document.getElementById("resultTextarea");
      const copyBtn = document.getElementById("copyBtn");
      const loading = document.getElementById("loading");
      const errorMessage = document.getElementById("errorMessage");
      const successMessage = document.getElementById("successMessage");

      let currentImageBase64 = "";

      // ä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
      uploadArea.addEventListener("click", () => {
        fileInput.click();
      });

      // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
      fileInput.addEventListener("change", handleFileSelect);

      // æ‹–æ‹½äº‹ä»¶
      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      });

      uploadArea.addEventListener("dragleave", () => {
        uploadArea.classList.remove("dragover");
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFile(files[0]);
        }
      });

      // ç²˜è´´äº‹ä»¶
      document.addEventListener("paste", (e) => {
        const items = e.clipboardData.items;
        for (let item of items) {
          if (item.type.indexOf("image") !== -1) {
            const blob = item.getAsFile();
            handleFile(blob);
            break;
          }
        }
      });

      // è¯†åˆ«æŒ‰é’®äº‹ä»¶
      recognizeBtn.addEventListener("click", recognizeText);

      // å¤åˆ¶æŒ‰é’®äº‹ä»¶
      copyBtn.addEventListener("click", copyResult);

      function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) {
          handleFile(file);
        }
      }

      function handleFile(file) {
        if (!file.type.startsWith("image/")) {
          showError("è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶");
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          currentImageBase64 = e.target.result;
          previewImage.src = currentImageBase64;
          previewArea.style.display = "block";
          recognizeBtn.disabled = false;
          hideMessages();

          // è‡ªåŠ¨æ‰§è¡Œè¯†åˆ«
          setTimeout(() => {
            recognizeText();
          }, 100);
        };
        reader.readAsDataURL(file);
      }

      async function recognizeText() {
        if (!currentImageBase64) {
          showError("è¯·å…ˆé€‰æ‹©å›¾ç‰‡");
          return;
        }

        showLoading(true);
        hideMessages();

        try {
          const response = await fetch(
            "https://xxx.com/v1/chat/completions",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "api-key": "xxx",
              },
              body: JSON.stringify({
                model: "qwen2.5-vl-72b-instruct",
                messages: [
                  {
                    role: "system",
                    content: "ä½ æ˜¯ä¸€ä¸ªAIåŠ©æ‰‹",
                  },
                  {
                    role: "user",
                    content: [
                      {
                        type: "image_url",
                        image_url: {
                          url: currentImageBase64,
                        },
                      },
                      {
                        type: "text",
                        text: "è¯·è¯†åˆ«å›¾ç‰‡ä¸­çš„æ‰€æœ‰æ–‡å­—å†…å®¹ï¼ŒåŒ…æ‹¬ä»»ä½•å¯è§çš„æ–‡æœ¬ã€æ•°å­—ã€ç¬¦å·ç­‰ã€‚åªè¾“å‡ºè¯†åˆ«åˆ°çš„æ–‡å­—å†…å®¹ï¼Œä¸è¦æ·»åŠ ä»»ä½•è§£é‡Šã€è¯´æ˜æˆ–æ ¼å¼åŒ–ï¼Œä¿æŒåŸæœ‰çš„æ¢è¡Œå’Œæ®µè½ç»“æ„ã€‚",
                      },
                    ],
                  },
                ],
                stream: false,
                max_tokens: 4096,
                temperature: 0.1,
              }),
            }
          );

          if (!response.ok) {
            throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status}`);
          }

          const data = await response.json();
          let text = data.choices[0].message.content;

          // å¦‚æœé€‰æ‹©äº†ä¸€è¡Œæ¨¡å¼ï¼Œå»é™¤æ¢è¡Œç¬¦
          if (oneLineMode.checked) {
            text = text.replace(/\n/g, " ").replace(/\s+/g, " ").trim();
          }

          resultTextarea.value = text;
          copyBtn.style.display = "inline-flex";
          showSuccess("è¯†åˆ«å®Œæˆï¼");
        } catch (error) {
          console.error("è¯†åˆ«é”™è¯¯:", error);
          showError("è¯†åˆ«å¤±è´¥: " + error.message);
        } finally {
          showLoading(false);
        }
      }

      function copyResult() {
        resultTextarea.select();
        document.execCommand("copy");

        // ä¸´æ—¶æ”¹å˜æŒ‰é’®æ–‡å­—
        const originalText = copyBtn.innerHTML;
        copyBtn.innerHTML = "<span>âœ…</span><span>å·²å¤åˆ¶</span>";

        setTimeout(() => {
          copyBtn.innerHTML = originalText;
        }, 2000);
      }

      function showLoading(show) {
        loading.style.display = show ? "block" : "none";
        recognizeBtn.disabled = show;
      }

      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = "block";
        successMessage.style.display = "none";
      }

      function showSuccess(message) {
        successMessage.textContent = message;
        successMessage.style.display = "block";
        errorMessage.style.display = "none";
      }

      function hideMessages() {
        errorMessage.style.display = "none";
        successMessage.style.display = "none";
      }
    </script>
  </body>
</html>
